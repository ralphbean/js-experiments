<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chart of frames/second with d3.js</title>
    <script type="text/javascript"
      src="http://code.jquery.com/jquery-1.6.4.min.js">
    </script>
    <script type="text/javascript"
      src="http://mbostock.github.com/d3/d3.js">
    </script>
    <script type="text/javascript"
      src="http://cdnjs.cloudflare.com/ajax/libs/modernizr/2.0.6/modernizr.min.js">
    </script>
    <script type="text/javascript"
      src="http://threebean.org/js-experiments/fps/fps.js">
    </script>
    <script type="text/javascript">
      $(document).ready(function (){
        var grid = {
          width: 1420,
          height: 750,
        };

        var balls = [];
        var num_balls = 20;
        for ( var i = 0; i < num_balls; i++ ) {
          balls.push({
            x: Math.random() * grid.width,
            y: Math.random() * grid.height,
            vx: 0,
            vy: 0,
          });
        }

        var canvas = document.getElementById('myCanvas');
        canvas.width = grid.width;
        canvas.height = grid.height;
        var c = canvas.getContext('2d');
        var mousePos = null;
        var mouse_weight = 10;

        if ( Modernizr.touch ) {
          console.log("touch");
        } else {
          $('canvas').bind('mousedown', function(ev) {
            mousePos = { x: ev.clientX, y: ev.clientY, };
          });
          $('canvas').bind('mousemove', function(ev) {
            if ( mousePos ) {
              mousePos = { x: ev.clientX, y: ev.clientY, };
            }
          });
          $('canvas').bind('mouseup', function(ev) {
            mousePos = null;
          });
        }

        function threshold(x, y) {
          var f = 0;
          for ( var i = 0; i < balls.length; i++ ) {
            d = Math.sqrt(
              Math.pow(balls[i].x - x, 2) +
              Math.pow(balls[i].y - y, 2)
            );
            g_force = 1 / Math.pow(d, 2);
            f += g_force;
          }
          return f;
        }

        var cell_size = 12;
        function draw_marching_squares() {
          var cell_map = [];
          for ( var i = 0; i < grid.width / cell_size; i += 1 ) {
            cell_map[i] = [];
            for ( var j = 0; j < grid.height / cell_size; j += 1 ) {
              cell_map[i][j] = threshold(i*cell_size, j*cell_size);
              if ( cell_map[i][j] > 0.00025 ) {
                c.beginPath();
                c.arc(i*cell_size, j*cell_size, cell_size/3, 0 , Math.PI*2, true);
                c.closePath();
                c.fill();
              }
            }
          }
        }
        function draw() {
          c.fillStyle = '#FFFFFF';
          c.fillRect(0, 0, canvas.width, canvas.height);
          c.fillStyle = '#000000';
          for ( var i = 0; i < balls.length; i++ ) {
            c.beginPath();
            c.arc(balls[i].x, balls[i].y, 2, 0, Math.PI*2, true);
            c.closePath();
            c.fill();
          }

          //draw_marching_squares();

          requestAnimFrame(draw);
        }


        function animate() {
          var scale = 9.8;
          for ( var i = 0; i < balls.length; i++ ) {
            var dx = 0;
            var dy = 0;

            // Update each ball based on every other ball
            for ( var j = 0; j < balls.length; j++ ) {
              if ( i == j ) { continue; }
              d = Math.sqrt(
                Math.pow(balls[i].x - balls[j].x, 2) +
                Math.pow(balls[i].y - balls[j].y, 2)
              );

              if ( d == 0 ) { 
                // OMG, what do we do?
                dx += (Math.random() * 2) - 1; 
                dy += (Math.random() * 2) - 1;
                continue;
              }

              g_force = 1 / Math.pow(d, 2);
              dx -= g_force * ((balls[i].x - balls[j].x)/d)
              dy -= g_force * ((balls[i].y - balls[j].y)/d)
            }

            if ( mousePos != null ) {
              d = Math.sqrt(
                Math.pow(balls[i].x - mousePos.x, 2) +
                Math.pow(balls[i].y - mousePos.y, 2)
              );
              if ( d == 0 ) { 
                // OMG, what do we do?
                dx += (Math.random() * 2) - 1; 
                dy += (Math.random() * 2) - 1;
                continue;
              }

              g_force = mouse_weight * (
                1 / Math.pow(d, 1) -
                cell_size*10 / Math.pow(d, 2)
              );
              dx -= g_force * ((balls[i].x - mousePos.x)/d)
              dy -= g_force * ((balls[i].y - mousePos.y)/d)
            }

            balls[i].vx += (dx * scale);
            balls[i].vy += (dy * scale);
          }

          var LIMIT = 50;
          for ( var i = 0; i < balls.length; i++ ) {
            if ( balls[i].vx > LIMIT ) { balls[i].vx = LIMIT / 100.0; }
            if ( balls[i].vy > LIMIT ) { balls[i].vy = LIMIT / 100.0; }

            balls[i].vx = 99 * balls[i].vx / 100.0;
            balls[i].vy = 99 * balls[i].vy / 100.0;
          }

          for ( var i = 0; i < balls.length; i++ ) {
            balls[i].x += balls[i].vx;
            balls[i].y += balls[i].vy;

            if ( balls[i].x < 0 ) {
              balls[i].x += grid.width;
            }
            if ( balls[i].y < 0 ) {
              balls[i].y += grid.height;
            }
            if ( balls[i].x > grid.width ) {
              balls[i].x = balls[i].x % grid.width;
            }
            if ( balls[i].y > grid.height ) {
              balls[i].y = balls[i].y % grid.height;
            }
          }
          requestAnimFrame(animate);
        }

        animate();
        draw();

      });
    </script>

  </head>
  <body>
    <div><strong>TODO</strong>  Use the following as a reference...
      <a href="http://www.idevgames.com/forums/thread-8761.html">
        http://www.idevgames.com/forums/thread-8761.html</a>
    </div>
    <canvas id='myCanvas'></canvas>
  </body>
</html>
